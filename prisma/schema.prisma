generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  login          String?
  role           UserRole  @default(user)
  isAdmin        Boolean   @default(false)
  accounts       Account[]
  sessions       Session[]
  student        Student?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum UserRole {
  user
  admin
}

model Allowlist {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Phase 1: Scout Models

model Student {
  id                String              @id @default(cuid())
  userId            String              @unique
  name              String
  email             String              @unique
  year              String? // freshman, sophomore, junior, senior
  biggestChallenge  String? // From onboarding
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  onboardingComplete Boolean           @default(false)

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks             Task[]
  conversations    Conversation[]
  preferences      StudentPreferences?
  classSchedules   ClassSchedule[]

  @@index([userId])
}

enum TaskComplexity {
  simple
  medium
  complex
}

enum ConversationType {
  daily_planning
  task_specific
}

model Task {
  id                   String    @id @default(cuid())
  studentId            String
  description          String
  complexity           TaskComplexity
  category             String? // exam, assignment, life, etc.
  dueDate              DateTime?
  clarificationComplete Boolean  @default(false)
  clarificationData    Json? // Stores Q&A responses
  completed            Boolean   @default(false)
  completedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  student              Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  conversations        Conversation[]   // Task-specific chat threads

  @@index([studentId])
  @@index([dueDate])
}

model Conversation {
  id                   String            @id @default(cuid())
  studentId            String
  conversationType     ConversationType  @default(daily_planning)
  taskId               String?           // Links to specific task for task_specific type
  dailyConversationDate DateTime?        // Date for daily planning conversations
  messages             Json              // Array of {role, content, timestamp}
  context              Json?             // Relevant context for the conversation
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  student              Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  task                 Task?             @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([taskId])
  @@index([dailyConversationDate])
  @@index([conversationType])
  @@index([createdAt])
}

model StudentPreferences {
  id                     String   @id @default(cuid())
  studentId              String   @unique
  peakEnergyTimes        Json? // Array of time ranges
  preferredBreakLength   Int      @default(10) // minutes
  morningPerson          Boolean?
  studyAloneVsGroup      String? // alone, groups, mix
  studyEnvironmentPrefs  Json?
  effectiveStudyPatterns Json? // Learned patterns
  notificationSettings   Json?
  updatedAt              DateTime @updatedAt

  student                Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model ClassSchedule {
  id          String    @id @default(cuid())
  studentId   String
  courseName  String
  courseCode  String?
  professor   String?
  meetingTimes Json // Array of {day, startTime, endTime}
  semester    String
  syllabus    String? // URL or file path
  exams       Json? // Array of DateTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
}
